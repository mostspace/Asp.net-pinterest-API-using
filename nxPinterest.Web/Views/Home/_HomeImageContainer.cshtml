@model IList<nxPinterest.Data.Models.UserMedia>

<div id="blockGallery" class="multiImageSelect-noselect">
    <div class="m-3">
        <div class="content gallery" id="contentGallery">
            <div class="thumbnail-container" id="thumbnail-container">
            </div>
        </div>
    </div>
</div>

<script>
	window.page = 1;
    window.images = new Array();
    window.itemWidth = 250;
    $(document).ready(function() {
        $(window).css('min-width', 500);
        initCol();
        loadImg();
        $(window).scroll(function() {
            if($(window).scrollTop() + $(window).height() == $(document).height()) {
                loadImg();
            }
        });
        var timer = null;
        $(window).on('resize', function(){
            clearTimeout(timer);
            timer = setTimeout(function() {
                reloadImage();
            },300);
        });
    });
    function getColNum(itemWidth) {
        var col_num = Math.floor($(window).width() / itemWidth);
        return col_num;
    }
    function initCol() {
        var itemWidth = window.itemWidth;
        $("#thumbnail-container").empty();
        var col_num = getColNum(itemWidth);
        var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
        var space = Math.floor((width % itemWidth)/2) + 8;
        for (var i = 1; i <= col_num; i++) {
            var paddingItem = 4;
            var padding = paddingItem * 2;
            var leftSize = ((itemWidth - paddingItem) * (i - 1) + space);
            $('#thumbnail-container').append('<div id="column-'+i+'" class="image-col" style="position:absolute; width:' + itemWidth +'px; padding:' + padding + 'px;left:'+ leftSize +'px;"></div>');
        }
    }
    function reloadImage() {
        initCol();
        window.images.forEach(function (data) {
            data.forEach(function (value) {
                appendData(value);
            });
        });
    
    }
    function loadImg() {
        $.ajax({
            url: "@Url.Action("getMedia", "UserMedia")",
            method: "Post",
            data: { pageIndex: window.page, searchKey: $('#SearchKey').val() },
            success: function (sResult) {
                window.images.push( sResult.userMediaList);
                $.each(sResult.userMediaList, function(index, value) {
                    appendData(value);
                });
                window.page = window.page + 1;
            },
            error: function () {
                window.images.forEach(function (data) {
                    data.forEach(function (value) {
                        appendData(value);
                    });
                });
                window.page = window.page + 1;
            }
        });
    }
    function appendData(value) {
        var newImgEl = document.createElement('img');
        var previewButtonEl = '<span class="previewButton" onclick="showPreviewImage(\'' + value.mediaSmallUrl  + '\')"><i class="bi bi-zoom-in fa-lg px-2"></i></span>';
        newImgEl.addEventListener('load', function() {
            shortest = findShortestCol();
            shortest.append('<figure id="'+value.mediaId+'"><figcaption><p class="title">'+value.mediaTitle+'</p><p class="description">'+value.mediaDescription+'</p></figcaption></figure>');
            $('#'+value.mediaId).append(newImgEl);
            $('#'+value.mediaId).append(previewButtonEl);
        });
        newImgEl.setAttribute('src', value.mediaThumbnailUrl);
        newImgEl.setAttribute('alt', value.mediaFileName);
        newImgEl.setAttribute('data-media-url', value.mediaUrl);
        newImgEl.setAttribute('data-smallmedia-url', value.mediaSmallUrl);
    }
    function findShortestCol() {
        var count = $("#thumbnail-container").children().length;
        var shortest = $("#column-1");
        for (var i = 1; i <= count; i++) {
            if (Math.floor(shortest.height()) > Math.floor($("#column-"+ i +"").height())) {
                shortest = $("#column-" + i + "");
            }
        }
        return shortest;
    }
    function onViewUserMediaDetails(media_id) {
        $("#imagePreview").html("");

        OnGetUserMediaDetails(media_id).then(function (html) {
            $("#contentGallery").hide();
            $("#sectionPagination").hide();
            $(".add-image-container").hide();

            $("#imagePreview").append(html);
            $("#imagePreview").show();
        });
    }

    async function OnGetUserMediaDetails(media_id) {
        var promise = await new Promise(function (resolve, reject) {
            $.ajax({
                url: "@Url.Action("Details", "UserMedia")",
                method: "Post",
                data: { media_id },
                success: function (sResult) {
                    resolve(sResult);
                }
            });
        });

        return promise;
    }

    function ShowHomeImageContainer() {
        $("#imagePreview").hide();
        $("#imagePreview").html("");
        $(".add-image-container").show();
        $("#sectionPagination").show();
        $("#contentGallery").show();
    }

    function getCurrentZoomRange() {
        var changeZoomRange = document.getElementById("changeZoomRange");
        return Number(changeZoomRange.value);
    }

    function changeZoom() {
        var zoomSize = getCurrentZoomRange();
        var rangeWidth = 50;
        window.itemWidth = 100 + rangeWidth * zoomSize;

        var timer = null;
        clearTimeout(timer);
        timer = setTimeout(function () {
            reloadImage();
        }, 300);
    }

    function changeZoomOut() {
        var zoomSize = getCurrentZoomRange();
        if (zoomSize <= 0) {
            return;
        }
        document.getElementById("changeZoomRange").value = zoomSize - 1;
        changeZoom();
    }

    function changeZoomIn() {
        var zoomSize = getCurrentZoomRange();
        if (zoomSize >= 6) {
            return;
        }
        document.getElementById("changeZoomRange").value = zoomSize + 1;
        changeZoom();
    }
</script>
